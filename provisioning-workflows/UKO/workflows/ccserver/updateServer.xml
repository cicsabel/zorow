<?xml version="1.0" encoding="UTF-8"?>

<!-- Declare external file containing WAS variables referenced in the following steps -->
<!DOCTYPE workflow [<!ENTITY variables SYSTEM "variable_imports.xml">
                    <!ENTITY step_stop_server SYSTEM "steps/stop_server.xml">
                    ]> 
                    
<!--
/******************************************************************************/
/* Copyright Contributors to the zOS-Workflow Project.                        */
/* SPDX-License-Identifier: Apache-2.0                                        */
/******************************************************************************/
-->
<workflow xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../workflow/schemas/workflow_v1.xsd">
    <!--  Note: The schema workflow_v1.xsd is shipped with z/OSMF. To use the schema
          to validate this XML, modify the above schema location to point to the 
          schema in z/OSMF, or copy the schema to an appropriate location.  -->

    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Update a server                                                      -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

  <workflowInfo>
      <workflowID>cc_Update</workflowID>
      <workflowDescription>Update a server.</workflowDescription>
    <workflowVersion>1.0.0.0</workflowVersion>
        <!-- Build timestamp 2021.05.09.21.03.24 -->
      <vendor>IBM</vendor>
      <Provisioning>
          <productID>5655-EKM</productID>
          <productName>UKO</productName>
          <productVersion>V2R1+</productVersion>
          <softwareType>ccserver</softwareType>
      </Provisioning>
  </workflowInfo>
  
  	<!--+++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
	<!--     Include variables used by the following steps     -->
	<!--+++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
	&variables;

    <variable name="CC_SERVER_UPDATE" scope="instance" visibility="public">
        <label>CC_SERVER_UPDATE</label>
        <abstract>Server version after update</abstract>
        <description>Which version of CC has been updated to?</description>
        <category>String Variables</category>
        <string />
    </variable>

	<atCreate name="CC_INSTALL_DIR" scope="instance" prompt="true" required="false"/>
	<atCreate name="START_SERVER" scope="instance" prompt="true" required="false"/>
    <atCreate name="JAVA_HOME" scope="instance" prompt="true" required="false"/>
    <atCreate name="DB_LIBPATH" scope="instance" prompt="true" required="false"/>
    <atCreate name="DB_CLASSPATH" scope="instance" prompt="true" required="false"/>
    <!-- those variables don't need to be queried because they are provieded from the instance -->
    <!-- <atCreate name="CC_TLS_KEY_STORE_SERVER_CERT" scope="instance" prompt="true" required="false"/> -->
    <!-- <atCreate name="CC_OIDC_PROVIDER_CERT" scope="instance" prompt="true" required="false"/> -->
    <!-- <atCreate name="CC_UNAUTHENTICATED_USER" scope="instance" prompt="true" required="false"/> -->

    <!--++++++++++++++++++++++-->
    <!--   Stop the server    -->
    <!--++++++++++++++++++++++-->  

     &step_stop_server;

    <!--++++++++++++++++++++++-->
    <!--   check versions     -->
    <!--++++++++++++++++++++++-->  

    <step name="createVersionVariables" optional="false">
        <title>Create variables for the versions</title>
        <description>Retrieves the current and the new version and puts the results in variables to be used by later steps</description>
        <runAsUser substitution="true">$!{instance-CC_ADMIN_ZFS}</runAsUser>
        <approver substitution="true">$!{instance-CC_APPROVER_ZFS}</approver>
        <variableValue name="CC_SERVER_DIRECTORY" scope="instance" noPromptIfSet="false" required="false"/>
        <variableValue name="CC_INSTALL_DIR" scope="instance" noPromptIfSet="false" required="false"/>
        <variableValue name="TEMP_DIR" scope="instance" noPromptIfSet="false" required="false"/>
        <instructions substitution="true">Submit shell script to execute step</instructions>
        <weight>1</weight>
        <autoEnable>true</autoEnable>
        <template>
            <inlineTemplate substitution="true">
        
                # Get the current version
                currentversion=$(iconv -t IBM037 -f utf-8 ${instance-CC_SERVER_DIRECTORY}/EkmfWeb.properties | grep com.ibm.websphere.productVersion | sed -E 's/.*=([^\$])/\1/')

                if [[ "${currentversion}" &lt; "2" ]]; then
                    echo "The current version is a version from the EKMF Web Service:" ${currentversion}
                    # Grabbing the last character of the current version
                    microversion=$(echo $currentversion | sed 's/.*\(.\)/\1/')
                    currentversion="2.1.0.${microversion}"
                    echo "The version has been converted to the product version:" ${currentversion}
                fi

                # Get the new version
                newversion=$(iconv -t IBM037 -f utf-8 ${instance-CC_INSTALL_DIR}/EkmfWeb.properties | grep com.ibm.websphere.productVersion | sed -E 's/.*=([^\$])/\1/')

                
                echo "CC_SERVER_VERSION ${currentversion}" >> ${instance-TEMP_DIR}/zosmf-${_workflow-workflowKey}.properties
                echo "CC_SERVER_UPDATE ${newversion}" >> ${instance-TEMP_DIR}/zosmf-${_workflow-workflowKey}.properties

                chmod 744 ${instance-TEMP_DIR}/zosmf-${_workflow-workflowKey}.properties
            </inlineTemplate>
            <submitAs>shell-JCL</submitAs>
            <output substitution="true" needResolveConflicts="false">${instance-TEMP_DIR}/zosmf-${_workflow-workflowKey}.properties</output>
        </template>
    </step>

    <!--++++++++++++++++++++++++++-->
    <!--  Update the server dir   -->
    <!--++++++++++++++++++++++++++-->  
	
    <step name="updateDirectories">
        <title>Update config files and directories</title>
        <description>Update files and directories required by the new server</description>

        <step name="backupServerDir">
            <title>Backup server directory</title>
            <description>Submit script to backup the server directory</description>
            <runAsUser substitution="true">$!{instance-CC_ADMIN_SERVER}</runAsUser>
            <approver substitution="true">$!{instance-CC_APPROVER_SERVER}</approver>
            <variableValue name="CC_SERVER_DIRECTORY" scope="instance" noPromptIfSet="false" required="false"/>
            <instructions substitution="true">Submit shell script to execute step</instructions>
            <weight>1</weight>
            <autoEnable>true</autoEnable>
            <template>
                <inlineTemplate substitution="true">
                    # Get the current version
                    currentversion=${instance-CC_SERVER_VERSION}

                    # create backup directory
                    mkdir ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey};

                    # move everything into backup directory
                    mv ${instance-CC_SERVER_DIRECTORY}/EkmfWeb.properties ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/EkmfWeb.properties;
                    mv ${instance-CC_SERVER_DIRECTORY}/apps ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/apps;

                    if [ -d "${instance-CC_SERVER_DIRECTORY}/includes" ] 
                    then
                        mv ${instance-CC_SERVER_DIRECTORY}/includes ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/includes; 
                    fi
                    
                    if [ -d "${instance-CC_SERVER_DIRECTORY}/configDropins" ] 
                    then
                        mv ${instance-CC_SERVER_DIRECTORY}/configDropins ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/configDropins; 
                    fi


                    mv ${instance-CC_SERVER_DIRECTORY}/resources ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/resources;
                    mv ${instance-CC_SERVER_DIRECTORY}/server.xml ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/server.xml;		    
                    mv ${instance-CC_SERVER_DIRECTORY}/server.env ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/server.env;			    
                    mv ${instance-CC_SERVER_DIRECTORY}/jvm.options ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/jvm.options;			    

                    # Create a migration log
                    echo "Current server Version is: $currentversion" > ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/migration.log;
                </inlineTemplate>
                <submitAs>shell-JCL</submitAs>
            </template>
        </step>

        <step name="migrateJvmOptions">
		    <title>Migrate jvm.options</title>
	        <description>replace values in jvm.options with template variable values</description>
	        <runAsUser substitution="true">$!{instance-CC_ADMIN_SERVER}</runAsUser>
	        <approver substitution="true">$!{instance-CC_APPROVER_SERVER}</approver>
            <variableValue name="CC_INSTALL_DIR" scope="instance" noPromptIfSet="false" required="false"/>
            <variableValue name="TEMP_DIR" scope="instance" noPromptIfSet="false" required="false"/>
            <instructions substitution="true">Submit shell script to execute step</instructions>
            <weight>1</weight>
            <autoEnable>true</autoEnable>
            <template>
   		         <inlineTemplate substitution="true">

                    #extract all name=value pairs that are not commented out from old file
                    sed '/^[[:blank:]]*#/d;/^$/d' ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/jvm.options > ${instance-TEMP_DIR}/zosmf-${_workflow-workflowKey}_jvm.options; 

                    echo "********************************************" >> ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/migration.log;
                    echo "Parameters from jvm.options to be migrated: " >> ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/migration.log;
                    cat ${instance-TEMP_DIR}/zosmf-${_workflow-workflowKey}_jvm.options >> ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/migration.log;
                    # set the number of lines
                    lines=$(sed -n '$='  ${instance-TEMP_DIR}/zosmf-${_workflow-workflowKey}_jvm.options; ); 
                    echo "********************************************" >> ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/migration.log;
                    echo "Number of parameters to be transferred:" ${lines} >> ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/migration.log;
                    sedstring="";
                    nottransfered="";
                    transferred="";

                    i=0;
                    while  [ i -lt ${lines} ] 
                    do
                        let i=i+1;
                        # echo "i:$i";
                        ccvariable=$(sed "${i}q;d"  ${instance-TEMP_DIR}/zosmf-${_workflow-workflowKey}_jvm.options   | sed -E 's/([^=]*)=(.*)/\1/');
                        ccvalue=$(sed "${i}q;d"  ${instance-TEMP_DIR}/zosmf-${_workflow-workflowKey}_jvm.options   | sed -E 's/([^=]*)=(.*)/\2/');
                        echo  "$ccvariable is $ccvalue";
                        sedstring="${sedstring} s#^[ \#]*${ccvariable}=.*#${ccvariable}=${ccvalue}#g;";
                    
                        # remove leading -D so grep command does not break
                        grepstring=$(echo $ccvariable | cut -c3-);

                        #check whether the extracted variable is contained in the latest jvm.options
                        if !(grep -Fq "${grepstring}=" ${instance-CC_INSTALL_DIR}/jvm.options)
                        then
                            nottransfered="${nottransfered}\n${ccvariable}=${ccvalue}";
                        else
                            transfered="${transfered}\n$ccvariable";
                            # create rest string to update variables
                            # echo "{\"name\":\"$ccvariable\",\"value\":\"$ccvalue\",\"visibility\":\"public\"}," >> ${instance-TEMP_DIR}/zosmf-${_workflow-workflowKey}.properties;
                        fi

                    done
                    
                    # do the actual replacement
                    # echo "sedstring: $sedstring";
                    sed -e "$sedstring" ${instance-CC_INSTALL_DIR}/jvm.options > ${instance-CC_SERVER_DIRECTORY}/jvm.options;
                    echo "The following variable(s) have been transferred: $transfered\n" >> ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/migration.log;

                    if ["$nottransfered" = ""]
                    then
                        echo "All parameters were transferred" >> ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/migration.log;
                    else
                        echo "The following variable(s) can NOT be transferred automatically: ${nottransfered} \nVerify whether they still exist in the new version." >> ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/migration.log;
                        echo "# The following parameters might have been deprecated:\n${nottransfered}" >> ${instance-CC_SERVER_DIRECTORY}/jvm.options;
                    fi     

                </inlineTemplate>
            	<submitAs>shell-JCL</submitAs>
        	</template>
        </step>

        <step name="migrateServerEnv">
		    <title>Migrate server.env</title>
	        <description>replace values in server.env with template variable values</description>
	        <runAsUser substitution="true">$!{instance-CC_ADMIN_SERVER}</runAsUser>
	        <approver substitution="true">$!{instance-CC_APPROVER_SERVER}</approver>
            <instructions substitution="true">Submit shell script to execute step</instructions>
            <weight>1</weight>
            <autoEnable>true</autoEnable>
            <template>
   		         <inlineTemplate substitution="true">

                    #extract all name=value pairs that are not commented out from old file
                    sed '/^[[:blank:]]*#/d;/^$/d' ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/server.env > ${instance-TEMP_DIR}/zosmf-${_workflow-workflowKey}_server.env; 

                    echo "********************************************" >> ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/migration.log;
                    echo "Parameters from server.env to be migrated: " >> ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/migration.log;
                    cat ${instance-TEMP_DIR}/zosmf-${_workflow-workflowKey}_server.env >> ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/migration.log;

                    # set the number of lines
                    lines=$(sed -n '$='  ${instance-TEMP_DIR}/zosmf-${_workflow-workflowKey}_server.env; ); 
                    echo "********************************************" >> ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/migration.log;
                    echo "Number of parameters to be transferred:" ${lines} >> ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/migration.log;
                    sedstring="";
                    nottransfered="";
                    transferred="";


                    i=0;
                    while  [ i -lt ${lines} ] 
                    do
                        let i=i+1;
                        # echo "i:$i";
                        ccvariable=$(sed "${i}q;d"  ${instance-TEMP_DIR}/zosmf-${_workflow-workflowKey}_server.env  | sed -E 's/([^=]*)=(.*)/\1/');
                        ccvalue=$(sed "${i}q;d"  ${instance-TEMP_DIR}/zosmf-${_workflow-workflowKey}_server.env  | sed -E 's/([^=]*)=(.*)/\2/');
                        sedstring="${sedstring} s#^[ \#]*${ccvariable}=.*#${ccvariable}=${ccvalue}#g;";
                    
                        #check whether the extracted variable is contained in the latest server.env
                        if !(grep -Fq "${ccvariable}=" ${instance-CC_INSTALL_DIR}/server.env)
                        then
                            nottransfered="${nottransfered}\n${ccvariable}=${ccvalue}";
                        else
                            transfered="${transfered}\n$ccvariable";
                            # create rest string to update variables
                            # echo "{\"name\":\"$ccvariable\",\"value\":\"$ccvalue\",\"visibility\":\"public\"}," >> ${instance-TEMP_DIR}/zosmf-${_workflow-workflowKey}.properties;
                        fi
                    done
                    
                    # echo "sedstring: $sedstring";
                    sed -e "$sedstring" ${instance-CC_INSTALL_DIR}/server.env > ${instance-CC_SERVER_DIRECTORY}/server.env;
                    echo "The following variable(s) have been transferred: $transfered\n" >> ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/migration.log;

                    if ["$nottransfered" = ""]
                    then
                        echo "All parameters were transferred" >> ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/migration.log;
                    else
                        echo "The following variable(s) can NOT be transferred automatically: $nottransfered \nVerify whether they still exist in the new version." >> ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/migration.log;
                        echo "# The following parameters might have been deprecated:\n${nottransfered}" >> ${instance-CC_SERVER_DIRECTORY}/server.env;
                    fi     

                    </inlineTemplate>
            	<submitAs>shell-JCL</submitAs>
        	</template>
        </step>

        <step name="setDirectoryPermissions">
            <title>Set Directory Permissions</title>
            <description>Ensure the new jvm.options and server.env files can be accessed</description>
            <runAsUser substitution="true">$!{instance-CC_ADMIN_SERVER}</runAsUser>
            <approver substitution="true">$!{instance-CC_APPROVER_SERVER}</approver>
            <variableValue name="CC_SERVER_STC_USER" scope="instance" noPromptIfSet="false" required="false"/>
            <variableValue name="CC_SERVER_STC_GROUP" scope="instance" noPromptIfSet="false" required="false"/>
            <instructions substitution="true">Execute the script to transfer ownership of jvm.options and server.env in ${instance-CC_SERVER_DIRECTORY} to ${instance-CC_SERVER_STC_USER}</instructions>
            <weight>1</weight>
            <autoEnable>true</autoEnable>
            <template>
              <inlineTemplate substitution="true">
                    
                #if(${instance-CC_SERVER_STC_GROUP} != "" &amp;&amp; ${instance-CC_SERVER_STC_GROUP})
                    echo "Ensure that ${instance-CC_SERVER_STC_GROUP} has read access to ${instance-CC_SERVER_DIRECTORY}/server.env and jvm.options"
                    chown ${instance-CC_SERVER_STC_USER}:${instance-CC_SERVER_STC_GROUP} ${instance-CC_SERVER_DIRECTORY}/server.env
                    chmod 755 ${instance-CC_SERVER_DIRECTORY}/server.env
                    chown ${instance-CC_SERVER_STC_USER}:${instance-CC_SERVER_STC_GROUP} ${instance-CC_SERVER_DIRECTORY}/jvm.options
                    chmod 755 ${instance-CC_SERVER_DIRECTORY}/jvm.options
                #else
                    echo "Ensure that ${instance-CC_SERVER_STC_USER} has read access to ${instance-CC_SERVER_DIRECTORY}/server.env and jvm.options"
                    chown ${instance-CC_SERVER_STC_USER} ${instance-CC_SERVER_DIRECTORY}/server.env
                    chmod 700 ${instance-CC_SERVER_DIRECTORY}/server.env
                    chown ${instance-CC_SERVER_STC_USER} ${instance-CC_SERVER_DIRECTORY}/jvm.options
                    chmod 700 ${instance-CC_SERVER_DIRECTORY}/jvm.options
                #end
    
                if [ $? -gt 1 ]; then 
                    echo "ERROR: Could not chmod directory" >&amp;2;
                    exit "8"; 
                fi
    
              </inlineTemplate>
              <submitAs>shell-JCL</submitAs>
               </template>
        </step>

        <step name="createSymLinks">
            <title>Create SymLinks to install directory</title>
            <description>Submit script to create symbolic links to the installation diretory. </description>
            <runAsUser substitution="true">$!{instance-CC_ADMIN_SERVER}</runAsUser>
            <approver substitution="true">$!{instance-CC_APPROVER_SERVER}</approver>
            <instructions substitution="true">Submit shell script to execute step</instructions>
            <weight>1</weight>
            <autoEnable>true</autoEnable>
            <template>
                <inlineTemplate substitution="true">

                    # Create symlinks to the updated installation folder
                    cd ${instance-CC_SERVER_DIRECTORY}
                    ln -s ${instance-CC_INSTALL_DIR}/EkmfWeb.properties EkmfWeb.properties
                    ln -s ${instance-CC_INSTALL_DIR}/apps apps

                    if [ -d "${instance-CC_INSTALL_DIR}/includes" ] 
                    then
                        ln -s ${instance-CC_INSTALL_DIR}/includes includes; 
                    fi
                    if [ -d "${instance-CC_INSTALL_DIR}/configDropins" ] 
                    then
                        echo "configDropins folder found in ${instance-CC_INSTALL_DIR}"
                        echo "creating ${instance-CC_SERVER_DIRECTORY}/configDropins"
                        mkdir configDropins

                        echo "creating symlinks to the configDropins subfolders"

                        echo "creating symlink to ${instance-CC_INSTALL_DIR}/configDropins/defaults"
                        ln -s ${instance-CC_INSTALL_DIR}/configDropins/defaults configDropins/defaults

                        echo "creating symlink to ${instance-CC_INSTALL_DIR}/configDropins/options"
                        ln -s ${instance-CC_INSTALL_DIR}/configDropins/options configDropins/options

                        echo "creating ${instance-CC_SERVER_DIRECTORY}/configDropins/overrides"
                        mkdir configDropins/overrides  
                        echo "configDropins is set up: "
                        ls -al configDropins/

                        if [ -d "${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/configDropins/overrides" ] 
                        then
                            echo "migrating overrides, details in ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/migration.log"
                            echo "********************************************" >> ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/migration.log;
                            echo "configDropins/overrides found, starting migration" >> ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/migration.log;
                            for i in `ls ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/configDropins/overrides | xargs echo`; do 
                                if [[ -L ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/configDropins/overrides/$i ]]; then 
                                    echo "$i is a symbolic link, trying to relink to the new target folder" >> ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/migration.log;
                                    if [ -f "${instance-CC_INSTALL_DIR}/configDropins/options/${i}" ]; then
                                        echo "$i found in the new options folder and relinked" >> ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/migration.log;
                                        ln -s ${instance-CC_INSTALL_DIR}/configDropins/options/${i} configDropins/overrides/${i}
                                    elif [ -f "${instance-CC_INSTALL_DIR}/configDropins/defaults/${i}" ]; then
                                        echo "$i was found in the defaults folder and does not need to get overridden. The file is not copied." >> ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/migration.log;
                                    else
                                        echo "$i was not found in the options folder. The link is preserved but needs to be verified" >> ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/migration.log;
                                        cp -av ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/configDropins/overrides/${i} configDropins/overrides/${i} 
                                    fi
                                else 
                                    echo "$i will be copied to new overrides" >> ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/migration.log;
                                    cp ${instance-CC_SERVER_DIRECTORY}/backup_${_workflow-workflowKey}/configDropins/overrides/${i} configDropins/overrides/${i} 
                                fi    
                            done;            
                            echo "overrides is set up: "
                            ls -al configDropins/overrides                
                        fi

                        chown ${instance-CC_SERVER_STC_USER} configDropins
                        chown ${instance-CC_SERVER_STC_USER} configDropins/overrides

                        echo "Finished setting up configDropins"


                    fi
                    
                    ln -s ${instance-CC_INSTALL_DIR}/resources resources
                    ln -s ${instance-CC_INSTALL_DIR}/server.xml server.xml			    

                </inlineTemplate>
                <submitAs>shell-JCL</submitAs>
            </template>
        </step>

    </step>
	  
    <step name="additionalMigration">
        <title>Additional migration steps</title>
        <description>Additional steps to be executed after the directories have been migrated</description>

        <step name="backupFiles">
		    <title>Backup files before parameter migration</title>
	        <description>Create a backup of the individual files before migrating single parameters</description>
	        <runAsUser substitution="true">$!{instance-CC_ADMIN_SERVER}</runAsUser>
	        <approver substitution="true">$!{instance-CC_APPROVER_SERVER}</approver>
            <instructions substitution="true">Submit shell script to execute step</instructions>
            <weight>1</weight>
            <autoEnable>true</autoEnable>
            <template>
   		        <inlineTemplate substitution="true">
                    cp ${instance-CC_SERVER_DIRECTORY}/server.env ${instance-CC_SERVER_DIRECTORY}/server.env_backup
                </inlineTemplate>
            	<submitAs>shell-JCL</submitAs>
        	</template>
        </step>

        <step name="addUnauthenticatedUser">
		    <title>Add unauthenticated user</title>
	        <description>Adding the unauthenticated user to the server.env</description>
	        <runAsUser substitution="true">$!{instance-CC_ADMIN_SERVER}</runAsUser>
	        <approver substitution="true">$!{instance-CC_APPROVER_SERVER}</approver>
            <condition>
                <expression><![CDATA[${createVersionVariables.stepState} == "Complete"]]></expression>
                <description>Version variables must have been set</description>
                <targetStateSet>
                    <description>Skip this step if we are on a high enough version</description>
                    <extendStateExpression>
                        <description>Skip if the current version is already 2.1.0.4 or higher</description>
                        <expression>${instance-CC_SERVER_VERSION} >= "2.1.0.4"</expression>
                        <targetState>skipped</targetState>
                    </extendStateExpression>
                </targetStateSet>
            </condition>
            <variableValue name="CC_UNAUTHENTICATED_USER" scope="instance" noPromptIfSet="false" required="false"/>
            <instructions substitution="true">Submit shell script to execute step</instructions>
            <weight>1</weight>
            <autoEnable>true</autoEnable>
            <template>
   		        <inlineTemplate substitution="true">
                    # creating a copy of the server.env to work on, otherwise the sed command does not work
                    cp ${instance-CC_SERVER_DIRECTORY}/server.env ${instance-CC_SERVER_DIRECTORY}/server.env_temp

                    sed "s#^[ \#]*SAF_UNAUTHENTICATED_USER_ID=.*#SAF_UNAUTHENTICATED_USER_ID=${instance-CC_UNAUTHENTICATED_USER}#g" ${instance-CC_SERVER_DIRECTORY}/server.env_temp > ${instance-CC_SERVER_DIRECTORY}/server.env;

                    # deleting the copy
                    rm ${instance-CC_SERVER_DIRECTORY}/server.env_temp

                </inlineTemplate>
            	<submitAs>shell-JCL</submitAs>
        	</template>
        </step>

        <step name="addCertificates">
		    <title>Add individual certificate names</title>
	        <description>Adding the individual vertificate names for server and OIDC to the server.env</description>
	        <runAsUser substitution="true">$!{instance-CC_ADMIN_SERVER}</runAsUser>
	        <approver substitution="true">$!{instance-CC_APPROVER_SERVER}</approver>
            <condition>
                <expression><![CDATA[${createVersionVariables.stepState} == "Complete"]]></expression>
                <description>Version variables must have been set</description>
                <targetStateSet>
                    <description>Skip this step if we are on a high enough version</description>
                    <extendStateExpression>
                        <description>Skip if the current version is already 2.1.0.4 or higher</description>
                        <expression>${instance-CC_SERVER_VERSION} >= "2.1.0.4"</expression>
                        <targetState>skipped</targetState>
                    </extendStateExpression>
                </targetStateSet>
            </condition>
            <variableValue name="CC_TLS_KEY_STORE_SERVER_CERT" scope="instance" noPromptIfSet="false" required="false"/>
            <variableValue name="CC_OIDC_PROVIDER_CERT" scope="instance" noPromptIfSet="false" required="false"/>
            <instructions substitution="true">Submit shell script to execute step</instructions>
            <weight>1</weight>
            <autoEnable>true</autoEnable>
            <template>
   		        <inlineTemplate substitution="true">
                    # creating a copy of the server.env to work on, otherwise the sed command does not work
                    cp ${instance-CC_SERVER_DIRECTORY}/server.env ${instance-CC_SERVER_DIRECTORY}/server.env_temp

                    sed "s#^[ \#]*TLS_KEY_STORE_SERVER_CERT=.*#TLS_KEY_STORE_SERVER_CERT=${instance-CC_TLS_KEY_STORE_SERVER_CERT}#g;
                        s#^[ \#]*OIDC_PROVIDER_TRUST_ALIAS_NAME=.*#OIDC_PROVIDER_TRUST_ALIAS_NAME=${instance-CC_OIDC_PROVIDER_CERT}#g;
                        s#^[ \#]*OIDC_PROVIDER_KEY_ALIAS_NAME=.*#OIDC_PROVIDER_KEY_ALIAS_NAME=${instance-CC_OIDC_PROVIDER_CERT}#g" ${instance-CC_SERVER_DIRECTORY}/server.env_temp > ${instance-CC_SERVER_DIRECTORY}/server.env;

                    # deleting the copy
                    rm ${instance-CC_SERVER_DIRECTORY}/server.env_temp

                </inlineTemplate>
            	<submitAs>shell-JCL</submitAs>
        	</template>
        </step>

        <step name="verifyJavaHome">
		    <title>Verify Java home</title>
	        <description>The new version might need a newer version of Java, verify the version now.</description>
	        <runAsUser substitution="true">$!{instance-CC_ADMIN_SERVER}</runAsUser>
	        <approver substitution="true">$!{instance-CC_APPROVER_SERVER}</approver>
            <condition>
                <expression><![CDATA[${createVersionVariables.stepState} == "Complete"]]></expression>
                <description>Version variables must have been set</description>
                <targetStateSet>
                    <description>Skip this step if we are on V3 or higher</description>
                    <extendStateExpression>
                        <description>Skip if the current version is already V3 or higher</description>
                        <expression>${instance-CC_SERVER_VERSION} >= "3.1.0.0"</expression>
                        <targetState>skipped</targetState>
                    </extendStateExpression>
                </targetStateSet>
            </condition>
            <variableValue name="JAVA_HOME" scope="instance" noPromptIfSet="false" required="false"/>
            <instructions substitution="true">Submit shell script to execute step</instructions>
            <weight>1</weight>
            <autoEnable>true</autoEnable>
            <template>
   		        <inlineTemplate substitution="true">
                    # creating a copy of the server.env to work on, otherwise the sed command does not work
                    cp ${instance-CC_SERVER_DIRECTORY}/server.env ${instance-CC_SERVER_DIRECTORY}/server.env_temp

                    sed "s#JAVA_HOME=.*#JAVA_HOME=${instance-JAVA_HOME}#g" ${instance-CC_SERVER_DIRECTORY}/server.env_temp > ${instance-CC_SERVER_DIRECTORY}/server.env;

                    # deleting the copy
                    rm ${instance-CC_SERVER_DIRECTORY}/server.env_temp

                </inlineTemplate>
            	<submitAs>shell-JCL</submitAs>
        	</template>
        </step>

        <step name="verifyDb2Paths">
		    <title>Verify Db2 paths</title>
	        <description>The new version might need different Db2 paths from V3.1.0.2</description>
	        <runAsUser substitution="true">$!{instance-CC_ADMIN_SERVER}</runAsUser>
	        <approver substitution="true">$!{instance-CC_APPROVER_SERVER}</approver>
            <condition>
                <expression><![CDATA[${createVersionVariables.stepState} == "Complete"]]></expression>
                <description>Version variables must have been set</description>
                <targetStateSet>
                    <description>Skip this step if we are on 3.1.0.2 or higher</description>
                    <extendStateExpression>
                        <description>Skip if the current version is already 3.1.0.2 or higher</description>
                        <expression>${instance-CC_SERVER_VERSION} >= "3.1.0.2"</expression>
                        <targetState>skipped</targetState>
                    </extendStateExpression>
                    <extendStateExpression>
                        <description>Skip if you are upgrading to version lower than 3.1.0.2</description>
                        <expression>${instance-CC_SERVER_UPDATE} &lt; "3.1.0.2"</expression>
                        <targetState>skipped</targetState>
                    </extendStateExpression>
                </targetStateSet>
            </condition>
            <variableValue name="DB_LIBPATH" scope="instance" noPromptIfSet="false" required="false"/>
            <variableValue name="DB_CLASSPATH" scope="instance" noPromptIfSet="false" required="false"/>
            <instructions substitution="true">Submit shell script to execute step</instructions>
            <weight>1</weight>
            <autoEnable>true</autoEnable>
            <template>
   		        <inlineTemplate substitution="true">
                    # creating a copy of the server.env to work on, otherwise the sed command does not work
                    cp ${instance-CC_SERVER_DIRECTORY}/server.env ${instance-CC_SERVER_DIRECTORY}/server.env_temp

                    sed "s#^[ \#]*DB2_LIBPATH=.*#DB2_LIBPATH=${instance-DB_LIBPATH}#g;
                        s#^[ \#]*DB_LIBPATH=.*#DB_LIBPATH=${instance-DB_LIBPATH}#g;
                        s#^[ \#]*DB2_CLASSPATH=.*#DB2_CLASSPATH=${instance-DB_CLASSPATH}#g;
                        s#^[ \#]*DB_CLASSPATH=.*#DB_CLASSPATH=${instance-DB_CLASSPATH}#g" ${instance-CC_SERVER_DIRECTORY}/server.env_temp > ${instance-CC_SERVER_DIRECTORY}/server.env;

                    # deleting the copy
                    rm ${instance-CC_SERVER_DIRECTORY}/server.env_temp

                </inlineTemplate>
            	<submitAs>shell-JCL</submitAs>
        	</template>
        </step>

    </step>

    <step name="startServer">
        <title>Start the server</title>
        <description>Start the server</description>

        <step name="startServer_console">
        	<title>Start the server from console</title>
        	<description>Start the server from the console</description>
        	<runAsUser substitution="true">$!{instance-CC_ADMIN_CONSOLE}</runAsUser>
	        <approver substitution="true">$!{instance-CC_APPROVER_CONSOLE}</approver>
	        <condition>
      			<expression><![CDATA["1" == "1"]]></expression>
				<description>Should the step be executed, based on the START_SERVER setting</description>
				<targetStateSet>
					<description/>
	      			<extendStateExpression>
	      				<description>Skip if START_SERVER == false</description>
	            		<expression><![CDATA[ ${instance-START_SERVER} == "false"]]></expression>
	      				<targetState>Skipped</targetState>
	      			</extendStateExpression>
				</targetStateSet>
			</condition>
            <variableValue name="START_SERVER" scope="instance" noPromptIfSet="false" required="false"/>
            <variableValue name="CC_SERVER_STC_NAME" scope="instance" noPromptIfSet="false" required="false"/>
     		<instructions substitution="false">Submitting script to stop the server.</instructions>
        	<weight>1</weight>
        	<autoEnable>true</autoEnable>
        	<rest>
				<httpMethod>PUT</httpMethod>
				<uriPath substitution="true">/zosmf/restconsoles/consoles/defcn</uriPath>
				<requestBody substitution="true">
				  {
				    "cmd" : "START ${instance-CC_SERVER_STC_NAME},PARMS='${instance-CC_SERVER_STC_NAME}'",
				    "unsol-key" : "CWWKF0011I: The ${instance-CC_SERVER_STC_NAME} server is ready",
                    "unsol-detect-sync" : "Y",
				    "unsol-detect-timeout" : "120",
				    "detect-time" : "120",
				    "system" : "${_workflow-systemName}"
				    
				  }	
				</requestBody>
				<expectedStatusCode>200</expectedStatusCode>
				<propertyMapping mapTo="CC_REST_STATUS">["status"]</propertyMapping>
			</rest>
    	</step>
    	
    	<step name="CheckStartup" optional="false">
            <title>Checking the rest status from the start command</title>
            <description>Check the REST Status from the start command</description>
            <prereqStep name="startServer_console"/>
            <runAsUser substitution="true">$!{instance-CC_ADMIN_TSO}</runAsUser>
            <approver substitution="true">$!{instance-CC_APPROVER_TSO}</approver>
            <condition>
                <expression><![CDATA[${startServer_console.stepState} == "Complete" || ${startServer_console.stepState} == "Skipped"]]></expression>
                <description>Should the step be executed based on the CC_REST_STATUS setting</description>
                <targetStateSet>
                    <description>Check to see whether this step should be skipped</description>
                    <extendStateExpression>
                        <description>Only execute it CC_REST_STATUS is not detected</description>
                        <expression><![CDATA[ ${instance-CC_REST_STATUS} == "detected"]]></expression>
                        <targetState>Skipped</targetState>
                    </extendStateExpression>
	      			<extendStateExpression>
	      				<description>Skip if START_SERVER == false</description>
	            		<expression><![CDATA[ ${instance-START_SERVER} == "false"]]></expression>
	      				<targetState>Skipped</targetState>
	      			</extendStateExpression>
                </targetStateSet>
            </condition>
            <instructions>Execute simple Rexx command to always return a bad returncode</instructions>
            <weight>1</weight>
            <skills>z/OS Administration</skills>
            <autoEnable>true</autoEnable>
            <template>
                <inlineTemplate substitution="true">
                    exit 8
                </inlineTemplate>
                <submitAs maxRc="0">TSO-REXX-JCL</submitAs>
            </template>
        </step> 
    </step>

    <!--I can't make the rest update work with a file as part of the body 

        <step name="UpdateInstance" optional="false">
        <title>Update instance variables</title>
        <description>Make REST API call to update instance variables</description>
        <instructions>Call REST API to update instance variable</instructions>
        <weight>1</weight>
        <autoEnable>true</autoEnable>
        <rest>
            <httpMethod>PUT</httpMethod>
            <uriPath substitution="true">/zosmf/provisioning/rest/1.0/scr/${_workflow-parentRegistryID}/variables</uriPath>
            <requestBody substitution="true">
                #set ($restbody = ${(cat ${instance-TEMP_DIR}/zosmf-${_workflow-workflowKey}.properties)})
                {
   					"variables":[
                       ${restbody}
   					]
				}
            </requestBody>
            <expectedStatusCode>204</expectedStatusCode>
        </rest>
    </step> 
-->

    <step name="cleanUpVariables">
        <title>Clean up variables</title>
        <description>Submit script to clean up temp variables</description>
        <runAsUser substitution="true">$!{instance-CC_ADMIN_SERVER}</runAsUser>
        <approver substitution="true">$!{instance-CC_APPROVER_SERVER}</approver>
        <instructions substitution="true">Submit shell script to execute step</instructions>
        <weight>1</weight>
        <autoEnable>true</autoEnable>
        <template>
            <inlineTemplate substitution="true">
            
                #Remove temporary files
                rm ${instance-TEMP_DIR}/zosmf-${_workflow-workflowKey}.properties
                if [ $? -gt 0 ]; then 
                    echo "no temp file needed to be deleted"
                fi

                ${instance-TEMP_DIR}/zosmf-${_workflow-workflowKey}_server.env
                if [ $? -gt 0 ]; then 
                    echo "no temp server.env needed to be deleted"
                fi

                ${instance-TEMP_DIR}/zosmf-${_workflow-workflowKey}_jvm.options
                if [ $? -gt 0 ]; then 
                    echo "no temp jvm.options needed to be deleted"
                fi
            </inlineTemplate>
            <submitAs>shell-JCL</submitAs>
        </template>
    </step>

</workflow>
